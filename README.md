# ğŸ“˜ tag-refiner

WD14 (Danbooruå½¢å¼) ã‚¿ã‚°æ•´å½¢CLIãƒ„ãƒ¼ãƒ«

## æ¦‚è¦

**tag-refiner** ã¯æ©Ÿæ¢°å­¦ç¿’ç”¨ã®ç”»åƒã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢ã™ã‚‹Pythonè£½CLIãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

- âœ¨ ä¸è¦ã‚¿ã‚°ã®å‰Šé™¤ï¼ˆæ­£è¦è¡¨ç¾å¯¾å¿œï¼‰
- â• å¿…è¦ã‚¿ã‚°ã®è¿½åŠ 
- ğŸ”€ ã‚¿ã‚°é †ã®ãƒ©ãƒ³ãƒ€ãƒ åŒ–
- ğŸ’¾ å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- ğŸ” å·®åˆ†ç¢ºèªï¼ˆdry-run / diffï¼‰

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹
git clone https://github.com/da2el-ai/tag-refiner.git
cd tag-refiner

python -m venv venv

# Macã®å ´åˆ
source venv/bin/activate
# Windowsã®å ´åˆ
venv\Scripts\activate

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -e .
```

## ä½¿ã„æ–¹

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ï¼š

- `refine`: ã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢
- `list`: ã‚¿ã‚°ã®ä¸€è¦§ã‚’å‡ºåŠ›

```bash
# ã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢
tag-refiner refine ./sample

# ã‚¿ã‚°ã®ä¸€è¦§ã‚’è¡¨ç¤º
tag-refiner list ./sample

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
tag-refiner --version
```

### ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«

ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’**LoRAä½œæˆãƒ•ã‚©ãƒ«ãƒ€**ã«ä½œã£ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚<br>
ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã‚’ä¾‹ã«èª¬æ˜ã—ã¾ã™ã€‚

```
/lora-name
    +-- taglist.bat # ä»Šå›èª¬æ˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
    +-- refine.bat  # ä»Šå›èª¬æ˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
    +-- tag_add.txt    # è¿½åŠ ã‚¿ã‚°
    +-- tag_remove.txt # é™¤å¤–ã‚¿ã‚°
    +-- /train
        +-- /ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€
            +-- ç”»åƒ
```

#### ï¼œtaglist.batï¼

ã‚¿ã‚°ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚<br>

```bat
@echo on

call {tag-refinerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€}\venv\Scripts\activate
call tag-refiner list .\train -r --list-sort tag --list-file taglist.txt
```

#### ï¼œrefine.batï¼

ã‚¿ã‚°ã‚’æ•´å½¢ã™ã‚‹ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

```bat
@echo on

call {tag-refinerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€}\venv\Scripts\activate
call tag-refiner refine .\train -r --use-bak
```


### refineã‚³ãƒãƒ³ãƒ‰

ã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢ã—ã¾ã™ã€‚

```bash
# åŸºæœ¬çš„ãªä½¿ã„æ–¹
tag-refiner refine ./sample

# dry-runã§ç¢ºèª
tag-refiner refine ./sample --dry-run --diff

# å†å¸°çš„ã«å‡¦ç†
tag-refiner refine ./sample -r
```

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```
tag-refiner refine [PATH] [OPTIONS]

å¼•æ•°:
  PATH                      å‡¦ç†å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆçœç•¥æ™‚ã¯config.jsonã‹ã‚‰å–å¾—ï¼‰

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  -r, --recursive          ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‡¦ç†
  --shuffle/--no-shuffle   ã‚¿ã‚°ã®é †åºã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–
  --shuffle-keep-first N   ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ™‚ã«å…ˆé ­ã‹ã‚‰Nå€‹ã‚’å›ºå®šï¼ˆãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¿è­·ç”¨ï¼‰
  --backup/--no-backup     ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
  --backup-mode MODE       ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ [skip|overwrite|versioned]
  --dry-run                å®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã›ãšã€å‡¦ç†å†…å®¹ã®ã¿è¡¨ç¤º
  --diff                   å¤‰æ›´å‰å¾Œã®å·®åˆ†ã‚’è¡¨ç¤º
  --add-file PATH          è¿½åŠ ã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  --remove-file PATH       å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  --regexp/--no-regexp     é™¤å¤–ã‚¿ã‚°ã§æ­£è¦è¡¨ç¾ã‚’ä½¿ç”¨
  --use-bak                ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿æ™‚ã« .bak ã‚’å„ªå…ˆä½¿ç”¨
  --config PATH            è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: config.jsonï¼‰
  --no-config              è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ãªã„
```

`--use-bak` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€å„ `.txt` ã«å¯¾ã—ã¦èª­ã¿è¾¼ã¿å…ƒã‚’ `.txt.bak` â†’ `.txt` ã®é †ã§æ¢ç´¢ã—ã¾ã™ã€‚


### listã‚³ãƒãƒ³ãƒ‰

æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ã®ä¸€è¦§ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```bash
# åŸºæœ¬çš„ãªä½¿ã„æ–¹
tag-refiner list ./sample

# å‡ºç¾å›æ•°ã‚’è¡¨ç¤º
tag-refiner list ./sample --list-count

# ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
tag-refiner list ./sample --list-file tags.txt

# å‡ºç¾å›æ•°é †ã«ã‚½ãƒ¼ãƒˆ
tag-refiner list ./sample --list-count --list-sort count

# å†å¸°çš„ã«å‡¦ç†
tag-refiner list ./sample -r
```

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```
tag-refiner list PATH [OPTIONS]

å¼•æ•°:
  PATH                      å‡¦ç†å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆå¿…é ˆï¼‰

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  -r, --recursive          ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‡¦ç†
  --list-count             å‡ºç¾å›æ•°ã‚’è¡¨ç¤º
  --list-file PATH         å‡ºåŠ›ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°æ¨™æº–å‡ºåŠ›ï¼‰
  --list-sort MODE         ä¸¦ã³é † [tag|count]
                           tag: ã‚¿ã‚°ã®åå‰é †ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                           count: æ•°ã®å¤šã„é †
  --use-bak                ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿æ™‚ã« .bak ã‚’å„ªå…ˆä½¿ç”¨
```

`--use-bak` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€å„ `.txt` ã«å¯¾ã—ã¦èª­ã¿è¾¼ã¿å…ƒã‚’ `.txt.bak` â†’ `.txt` ã®é †ã§æ¢ç´¢ã—ã¾ã™ã€‚

## è¨­å®š

### config.json

```json
{
  "input_dir": "./sample",
  "recursive": false,
  "tag_add_file": "tag_add.txt",
  "tag_remove_file": "tag_remove.txt",
  "regexp": false,
  "shuffle": true,
  "shuffle_keep_first": 2,
  "backup": true,
  "backup_mode": "skip",
  "dry_run": false,
  "diff": false
}
```

- **input_dir**: å‡¦ç†å¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- **recursive**: `true` ã§ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‡¦ç†
- **tag_add_file**: è¿½åŠ ã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `tag_add.txt`
- **tag_remove_file**: é™¤å¤–ã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `tag_remove.txt`
- **regexp**: `true` ã§é™¤å¤–ã‚¿ã‚°ã«æ­£è¦è¡¨ç¾ã‚’ä½¿ç”¨
  - `false` ã®å ´åˆã¯å…¨ã¦å®Œå…¨ä¸€è‡´
  - `true` ã®å ´åˆã§ã‚‚ã€ãƒ¡ã‚¿æ–‡å­—ï¼ˆä¾‹: `.`, `+`, `*`ï¼‰ãŒãªã„è¡Œã¯å®Œå…¨ä¸€è‡´
- **shuffle**: `true` ã§ã‚¿ã‚°ã®é †åºã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–
- **shuffle_keep_first**: ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ™‚ã«å…ˆé ­ã‹ã‚‰Nå€‹ã‚’å›ºå®š
  - è¿½åŠ ã‚¿ã‚°ã‚’ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ã†å ´åˆã€è¿½åŠ ã‚¿ã‚°ã®å€‹æ•°ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§é †åºã‚’å›ºå®šã§ãã¾ã™
- **backup**: `true` ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
- **backup_mode**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰
  - skip: `.bak` ãŒå­˜åœ¨ã™ã‚Œã°ä½œæˆã—ãªã„
  - overwrite: æ—¢å­˜ `.bak` ã‚’ä¸Šæ›¸ã
  - versioned: `.bak.1`, `.bak.2` ã‚’ä½œæˆ
- **dry_run**: `true` ã§å®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã›ãšã€å‡¦ç†å†…å®¹ã®ã¿è¡¨ç¤º
- **diff**: `true` ã§å¤‰æ›´å‰å¾Œã®å·®åˆ†ã‚’è¡¨ç¤º


### tag_add.txt

è¿½åŠ ã—ãŸã„ã‚¿ã‚°ã‚’1è¡Œã«1ã¤ãšã¤è¨˜è¿°ã—ã¾ã™ã€‚

```text
# ã‚³ãƒ¡ãƒ³ãƒˆ
# è¿½åŠ ã‚¿ã‚°ã¯å¿…ãšå…ˆé ­ã«é…ç½®ã•ã‚Œã¾ã™
# æœ«å°¾ã®ã‚«ãƒ³ãƒã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™
slim body
detailed background
```

**æ³¨æ„:**

- è¿½åŠ ã‚¿ã‚°ã¯**å¿…ãšå…ˆé ­ã«é…ç½®**ã•ã‚Œã¾ã™
- æ—¢å­˜ã‚¿ã‚°ã¨é‡è¤‡ã™ã‚‹å ´åˆã¯ã€æ—¢å­˜ã®ä½ç½®ã‹ã‚‰å‰Šé™¤ã—ã¦å…ˆé ­ã«ç§»å‹•ã—ã¾ã™
- æœ«å°¾ã®ã‚«ãƒ³ãƒï¼ˆ`slim body,`ï¼‰ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™
- è¤‡æ•°å›å®Ÿè¡Œã—ã¦ã‚‚é‡è¤‡ã—ã¾ã›ã‚“

### tag_remove.txt

å‰Šé™¤ã—ãŸã„ã‚¿ã‚°ã‚’1è¡Œã«1ã¤ãšã¤è¨˜è¿°ã—ã¾ã™ã€‚

- `regexp: false` ã®å ´åˆ: ã™ã¹ã¦å®Œå…¨ä¸€è‡´ã§é™¤å¤–
- `regexp: true` ã®å ´åˆ: ãƒ¡ã‚¿æ–‡å­—ã‚’å«ã‚€è¡Œã®ã¿æ­£è¦è¡¨ç¾ã€ãã‚Œä»¥å¤–ã¯å®Œå…¨ä¸€è‡´

```text
# ã‚³ãƒ¡ãƒ³ãƒˆ
^background$
^simple background$
low quality
worst quality
```


## é–‹ç™º

```bash
# é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
python -m venv venv
source venv/bin/activate
pip install -e .

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest
```

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License
